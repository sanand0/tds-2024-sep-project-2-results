<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TDS 2024 Sep Project 2 Results</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<body>

  <h1 class="display-1 my-4 text-center">TDS 2024 Sep Project 2 Results</h1>

  <div class="container">
    <!-- Nav tabs -->
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item ms-auto" role="presentation">
        <button class="nav-link active" id="student-tab" data-bs-toggle="tab" data-bs-target="#student" type="button" role="tab" aria-controls="student" aria-selected="true">
          By student
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="test-tab" data-bs-toggle="tab" data-bs-target="#test" type="button" role="tab" aria-controls="test" aria-selected="false">
          By test
        </button>
      </li>
      <li class="nav-item me-auto" role="presentation">
        <button class="nav-link" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail" type="button" role="tab" aria-controls="detail" aria-selected="false">
          In detail
        </button>
      </li>
    </ul>

    <!-- Tab content -->
    <div class="tab-content mt-3">
      <div class="tab-pane fade show active" id="student" role="tabpanel" aria-labelledby="student-tab">
        <div id="loading" class="text-center my-5">
          <div class="spinner-border" role="status"></div>
        </div>
      </div>
      <div class="tab-pane fade" id="test" role="tabpanel" aria-labelledby="test-tab"></div>
      <div class="tab-pane fade" id="detail" role="tabpanel" aria-labelledby="detail-tab"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script type="module">
    /* globals bootstrap */
    import { render, html } from "https://cdn.jsdelivr.net/npm/lit-html@3/+esm";
    import { num2 } from "https://cdn.jsdelivr.net/npm/@gramex/ui@0.3/dist/format.js";
    import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";

    const data = await d3.csv("results.csv", d3.autoType);

    // links[id] = URL of submission
    const submissions = await d3.csv("submissions.csv", d3.autoType);
    const links = Object.fromEntries(submissions.map(s => [s[submissions.columns[1]].split("@")[0], s[submissions.columns[2]] ?? s[submissions.columns[2]]]));

    /**
     * Renders tables based on URL parameters
     * @param {Event} [event] - Optional hashchange event
     */
    async function renderTables(event) {
      const params = new URLSearchParams(location.hash.replace(/^#/, ""));
      const sort = params.get("sort");

      let filtered = data;
      // Handle filtering and tab selection
      for (const [key, value] of params) {
        if (data.columns.includes(key)) filtered = filtered.filter((row) => row[key] === value);
        if (key === "tab") {
          const $tab = document.querySelector(`#${value}-tab`);
          $tab.click();
        }
      }

      const agg = v => ({ marks: d3.sum(v, d => +d.marks), correct: d3.sum(v, d => +d.correct), tests: v.length, total: d3.sum(v, d => +d.total) })
      const marksById = d3.rollup(filtered, agg, d => d.id);
      const correctByTest = d3.rollup(filtered, agg, d => d.test);

      const max = d => ({ marks: d3.max(d.values(), d => d.marks), correct: d3.max(d.values(), d => d.correct), total: d3.max(d.values(), d => d.total), tests: d3.max(d.values(), d => d.tests) })
      const maxById = max(marksById);
      const maxByTest = max(correctByTest);

      const cell = (value, max, outOf, decimals) => html`<td class="text-end" style="position: relative; min-width: 200px; padding-left: 0;">
        <div style="position: absolute; width: ${num2(+value / max * 100)}%; height: calc(100% - 1rem); background-color: var(--bs-warning)"></div>
        <div style="position: relative; z-index: 1">${(+value).toFixed(decimals)}</div>
      </td>`;

      function sorted(iterable) {
        const result = [...iterable];
        if (sort == "id" || sort == "test") result.sort((a, b) => d3.ascending(a[0], b[0]))
        else result.sort((a, b) => d3.descending(+a[1][sort], +b[1][sort]))
        return result;
      }

      const updateHash = (newParams) => {
        const updatedParams = new URLSearchParams(params);
        Object.entries(newParams).forEach(([key, value]) => {
          if (updatedParams.get(key) === value) updatedParams.delete(key)
          else updatedParams.set(key, value);
        });
        location.hash = updatedParams.toString();
      };
      const sortClass = (key) => sort == key ? "text-bg-primary" : "";
      const filterClass = (key, value) => params.get(key) == value ? "text-bg-primary" : "";

      const summaryTable = (data, max, key) => html`
      <div class="table-responsive">
        <table class="table table-striped table-hover w-auto mx-auto">
          <thead>
            <tr>
              <th scole="col" role="button">#</th>
              <th scope="col" role="button" class="${sortClass(key)}" @click=${() => updateHash({ sort: key })}>${key}</th>
              <th scope="col" role="button" class="text-end ${sortClass("marks")}" @click=${() => updateHash({ sort: 'marks' })}>Marks</th>
              <th scope="col" role="button" class="text-end ${sortClass("total")}" @click=${() => updateHash({ sort: 'total' })}>Max Marks</th>
              <th scope="col" role="button" class="text-end ${sortClass("correct")}" @click=${() => updateHash({ sort: 'correct' })}>Checks</th>
              <th scope="col" role="button" class="text-end ${sortClass("tests")}" @click=${() => updateHash({ sort: 'tests' })}>Max Checks</th>
            </tr>
          </thead>
          <tbody>
            ${sorted(data.entries()).map(([id, { marks, total, correct, tests }], i) => html`
              <tr>
                <td>${id in links ? html`<a href="${links[id]}" target="_blank">${i + 1}</a>` : i + 1}</td>
                <td role="button" class="${filterClass(key, id)}" @click=${() => updateHash({ [key]: id })}>${id}</td>
                ${cell(marks, max.marks, total, 2)}
                <td class="text-end">${(+total).toFixed(2)}</td>
                ${cell(correct, max.correct, tests, 0)}
                <td class="text-end">${(+tests).toFixed(2)}</td>
              </tr>`)}
          </tbody>
        </table>
      </div>
      `

      render(summaryTable(marksById, maxById, "id"), document.querySelector("#student"));
      render(summaryTable(correctByTest, maxByTest, "test"), document.querySelector("#test"));

      const sortedData = d3.sort(filtered, (sort == "id" || sort == "test" || sort == "reason") ? d => d[sort] : d => -d[sort])
      render(html`
        <div class="table-responsive">
          <table class="table table-striped table-hover w-auto mx-auto">
            <thead>
              <tr>
                <th scole="col" role="button">#</th>
                <th scope="col" role="button" class="${sortClass("id")}" @click=${() => updateHash({ sort: 'id' })} class="text-end">ID</th>
                <th scope="col" role="button" class="${sortClass("test")}" @click=${() => updateHash({ sort: 'test' })} class="text-end">Test</th>
                <th scope="col" role="button" class="${sortClass("marks")}" @click=${() => updateHash({ sort: 'marks' })} class="text-end">Marks</th>
                <th scope="col" role="button" class="${sortClass("reason")}" @click=${() => updateHash({ sort: 'reason' })} class="text-end">Reason</th>
              </tr>
            </thead>
            <tbody>
              ${sortedData.slice(0, 1000).map(({ id, test, reason, marks, total }, i) => html`
                <tr>
                  <td>${id in links ? html`<a href="${links[id]}" target="_blank">${i + 1}</a>` : i + 1}</td>
                  <td role="button" class="${filterClass("id", id)}" @click=${() => updateHash({ id })}>${id}</td>
                  <td role="button" class="${filterClass("test", test)}" @click=${() => updateHash({ test })}>${test}</td>
                  ${cell(marks, total, total, 2)}
                  <td role="button" class="${filterClass("reason", reason)}" @click=${() => updateHash({ reason })}>${reason}</td>
                </tr>`)}
            </tbody>
          </table>
        </div>
        ${filtered.length > 1000 ? html`<div class="text-center">Showing 1000 / ${filtered.length} rows.</div>` : ""}
      `, document.querySelector("#detail"));

    }
    // Initial render
    await renderTables();
    document.querySelector("#loading").remove();
    // Listen for hash changes
    window.addEventListener('hashchange', renderTables);
  </script>
</body>

</html>
